# PROMPT 03 — CREATE TOUR (repeatable)\n\nYou are creating a new tour from a guide file. This prompt is designed to be run MULTIPLE TIMES, once for each tour you want to create.\n\nEach run produces a validated, passing tour with organized artifacts.\n\n## Pre-flight (required, every time)\n\nVerify these exist or STOP and tell the user which prompt to run:\n\n- `/tourkit/config/routes.json` (Prompt 01)\n- `/tourkit/config/events.json` (Prompt 01)\n- `/tourkit/maps/tour.map.json` (Prompt 02C)\n- `/tourkit/schema/tour.schema.json` (Prompt 02A)\n- `/tourkit/runner/runTour.ts` (Prompt 02A)\n- `/tourkit/scripts/generate-tour-from-guide.ts` (Prompt 02A)\n- `/tests/e2e/tourkit.spec.ts` (Prompt 02A)\n- `playwright.config.*` loads `tourkit/.env.tourkit` via dotenv (Prompt 00)\n- `tourkit/app/tourEvents.ts` exists and exports `emitTourEvent` (Prompt 00)\n- `tourkit/app/tourMode.ts` exists and is SSR-safe (Prompt 00)\n\n## Reliability rules (non-negotiable)\n\n1) Every `goto` must be followed by a readiness signal before clicking/filling.\n- Prefer `Wait for Route Ready (tour.event.route.ready)` or route-specific ready events.\n- If the event does not exist, you must add it in the app code and emit via `emitTourEvent("tour.event.route.ready", { routeKey })` when anchors are present and the page is interactive.\n\n2) Never “fix” flakiness by only cranking timeouts.\n- If a `waitForEvent` times out, confirm whether the event is actually emitted.\n- If it’s not emitted, add emission. If it is emitted, ensure buffering is installed in the runner.\n\n3) Long operations get explicit timeouts in the guide/tour:\n- Studio route ready: 60_000ms (cold boot safe)\n- Generation complete: 120_000ms (AI/generation safe)\n- Auth success: 60_000ms\n\n4) Default overlay is OFF for clean artifacts:\n- `TOUR_OVERLAY=0` should be the default in tour runs.\n- If you need to debug anchors visually, set `TOUR_OVERLAY=1`.\n\n## NEW: Rich step metadata for content generation (must be implemented)\n\nGoal: tours should double as a “content script” for producing a narrated walkthrough video:\n- short spoken narration per step\n- optional pre-action delay (to let dialogs/animations settle)\n- optional screenshot capture\n- optional annotation instructions for image tooling (e.g. NanoBanana Pro)\n- action + optional event wait\n\n### Compatibility constraints (critical)\n\n- Existing tour JSON must continue to run.\n- The runner MUST ignore unknown keys safely (it already should).\n- The schema + generator MUST be updated so these new fields validate.\n- The generator MUST support both:\n  - legacy `type: "say"` steps (existing)\n  - new `type: "narration"` steps (preferred going forward)\n\n### Required changes to schema + generator (you must do this in this prompt)\n\nUpdate `/tourkit/schema/tour.schema.json` and `/tourkit/scripts/generate-tour-from-guide.ts` so that:\n\nA) Rename `say` → `narration` (preferred)\n- New: `{ "type": "narration", "message": string, ... }`\n- Legacy support: `{ "type": "say", "message": string, ... }` MUST still validate and run.\n- The generator MUST output `type: "narration"` going forward.\n\nB) Add two new step types\n1) `screenshot`\n- Captures a screenshot as a standalone step (useful for “beat” frames).\n- Example:\n  ```json\n  {\n    "type": "screenshot",\n    "label": "Studio loaded",\n    "name": "studio-loaded",\n    "fullPage": true\n  }\n  ```\n- Back-compat: existing `snapshot` steps should remain supported. Either:\n  - keep `snapshot` as valid type, OR\n  - treat `snapshot` as an alias in generator/runner.\n\n2) `annotate`\n- Represents a post-processing instruction that targets the last screenshot (or a named screenshot) to generate an annotated image.\n- This step does NOT affect the web app. It exists to drive your downstream media pipeline.\n- Example:\n  ```json\n  {\n    "type": "annotate",\n    "label": "Highlight Generate button",\n    "targetScreenshot": "studio-form-ready",\n    "instructions": "Draw a bold circle around the Generate button and add an arrow labeled 'Generate'."\n  }\n  ```\n\nC) Add optional “content metadata” keys to ALL steps (allowed on any step type)\nThese keys are for narration/capture logic and should not break execution:\n\n- `preDelayMs?: number`\n  - A delay BEFORE the step does its primary action (or before the screenshot is taken).\n  - Used to wait for dialogs/animations/idle states.\n- `narration?: string`\n  - A short description of what this step is doing. This is the text you will eventually turn into speech.\n  - This is separate from a dedicated `narration` step so you can attach it to any action.\n- `capture?: { when: "before" | "after"; name: string; fullPage?: boolean }`\n  - Optional screenshot capture that is attached to a step (“before click” / “after click”).\n  - This is in addition to the standalone `screenshot` step.\n- `annotate?: { targetScreenshot?: string; instructions: string }`\n  - Optional annotation instruction attached to a step.\n  - If `targetScreenshot` is omitted, it targets the screenshot captured by `capture` (or the most recent screenshot).\n\nThe runner MUST:\n- honor `preDelayMs` by calling `page.waitForTimeout(preDelayMs)` before executing the step’s action\n- support `capture` by taking screenshots at the right time\n- support standalone `screenshot` steps\n- write out annotation jobs (JSON) for downstream processing (details below)\n\nD) Write annotation jobs for downstream tooling\nWhen an `annotate` step exists OR a step has an `annotate` field:\n- Do NOT call any image model from Playwright.\n- Instead, write a machine-readable job file into the tour artifact directory:\n  - `/tourkit/artifacts/<tourId>/<timestamp>/annotations.jsonl`\n- Each line should include:\n  - `tourId`, `stepIndex`, `label`, `screenshotPath`, `instructions`\n  - Optional: `style`, `notes`\n\nThis makes annotation deterministic and keeps Playwright runs stable.\n\n## Guide DSL reference (updated)\n\nEvery guide is a markdown file where each non-empty, non-comment line is one tour step.\n\nRules:\n- Every actionable line MUST include an anchor `(tour.*)` or event `(tour.event.*)` in parentheses.\n- Anchors MUST start with `tour.`\n- Events MUST start with `tour.event.`\n- Never use text selectors.\n\n### Step types (guide → JSON)\n\nSupport these guide lines:\n\n- `Narration: <message text>`\n  - Generates a JSON step: `{ type: "narration", message }`\n  - NOTE: legacy `Say:` lines may exist; they should still parse, but generator should emit `narration` output.\n\n- `Goto routeKey: <routeKey>`\n  - Generates `{ type: "goto", routeKey }`\n  - Generator may add `preDelayMs` if specified.\n\n- `Click <human label> (<tour.anchor.name>)`\n  - Generates `{ type: "click", label, anchor }`\n\n- `Fill <human label> (<tour.anchor.name>) value:<literal>`\n  - Generates `{ type: "fill", label, anchor, value }`\n\n- `Fill <human label> (<tour.anchor.name>) env:<ENV_VAR_NAME>`\n  - Generates `{ type: "fill", label, anchor, valueEnv }`\n\n- `Expect visible <human label> (<tour.anchor.name>) timeout:<ms>`\n  - Generates `{ type: "expectVisible", label, anchor, timeoutMs }`\n\n- `Wait for <human label> (<tour.event.name>) timeout:<ms>`\n  - Generates `{ type: "waitForEvent", label, name, timeoutMs }`\n\n- `Wait <N>ms`\n  - Generates `{ type: "waitMs", durationMs }`\n\n- `Screenshot <human label> name:<slug> [fullPage:true|false]`\n  - Generates `{ type: "screenshot", label, name, fullPage? }`\n\n- `Annotate <human label> target:<slug> instructions:<free text>`\n  - Generates `{ type: "annotate", label, targetScreenshot, instructions }`\n\n- `Include fragment: <fragment_name>`\n  - Inlines `/tourkit/guides/_fragments/<fragment_name>.md`\n\n### Optional modifiers (apply to the step on the same line)\n\nAllow these suffix tokens at the end of ANY step line, parsed into the new optional keys:\n\n- `predelay:<ms>`\n  - Sets `preDelayMs`\n\n- `narration:<text>`\n  - Sets `narration` (short, step-specific)\n\n- `capture:before:<slug>` or `capture:after:<slug>`\n  - Sets `capture.when` + `capture.name`\n\n- `annotate:<text>`\n  - Sets `annotate.instructions` and targets the captured screenshot (or most recent)\n\nIf parsing this is too much for now, implement the JSON shape first, then add guide sugar second. Do NOT invent fake parsing behavior.\n\n## Step 0 — Required intro narration (new rule)\n\nEvery generated tour MUST start with an intro narration step that:\n- introduces the tour purpose and what will happen\n- is no more than ~30 seconds when spoken\n- is a single `narration` step (not multiple)\n\nIf the guide does not include an intro, the generator MUST auto-insert it as step 1.\n\nExample intro (edit per tour):\n```json\n{\n  "type": "narration",\n  "message": "Welcome! In this quick tour we’ll create a thumbnail from scratch: set the title, pick aspect ratio and resolution, generate variations, and open the first result."\n}\n```\n\n## Step A — Create or locate the guide\n\nIf `/tourkit/guides/<tourId>.md` exists, read it. Otherwise create it using anchors/events from the map.\n\nIf you need an anchor that does not exist:\n- Add `data-tour="tour...."` to the real element\n- Add it to ANCHOR_EVENT_PLAN.md\n- Regenerate map: `npm run tourkit:map`\n- Do not guess anchor names\n\nIf you need an event that does not exist:\n- Add the event to the canonical list (events.json / plan) as required by your system\n- Emit it from the app via `emitTourEvent(...)`\n- Confirm the runner buffers events (so the wait cannot miss it)\n\n## Step B — Generate tour JSON (updated output)\n\nRun:\n```\nnpm run tourkit:gen -- tourkit/guides/<tourId>.md\n```\n\nThe generator must:\n- resolve fragments\n- validate anchors against the map\n- validate events against events.json\n- validate routeKeys against routes.json\n- validate the final JSON against the UPDATED schema\n- write `/tourkit/tours/<tourId>.tour.json`\n\n### Expected JSON shape (example)\n\nThis is illustrative only. Do NOT hardcode these anchors; use real ones.\n\n```json\n{\n  "tourId": "first-thumbnail",\n  "description": "Generated from guide first-thumbnail.md",\n  "steps": [\n    {\n      "type": "narration",\n      "message": "Welcome! In this quick tour we’ll create a thumbnail from scratch: set the title, pick aspect ratio and resolution, generate, and open the first result."\n    },\n    {\n      "type": "goto",\n      "routeKey": "auth",\n      "preDelayMs": 250\n    },\n    {\n      "type": "fill",\n      "label": "Email",\n      "anchor": "tour.auth.form.input.email",\n      "valueEnv": "E2E_EMAIL",\n      "narration": "First, we’ll log in with a test account.",\n      "capture": { "when": "after", "name": "auth-email-filled", "fullPage": true }\n    },\n    {\n      "type": "click",\n      "label": "Login",\n      "anchor": "tour.auth.form.btn.submit",\n      "capture": { "when": "after", "name": "auth-submitted" }\n    },\n    {\n      "type": "waitForEvent",\n      "label": "Auth Success",\n      "name": "tour.event.auth.success",\n      "timeoutMs": 60000\n    },\n    {\n      "type": "goto",\n      "routeKey": "studio.create",\n      "narration": "Now we’ll jump into the Studio and set up the generation options."\n    },\n    {\n      "type": "waitForEvent",\n      "label": "Studio Ready",\n      "name": "tour.event.route.ready",\n      "timeoutMs": 60000\n    },\n    {\n      "type": "screenshot",\n      "label": "Studio loaded",\n      "name": "studio-loaded",\n      "fullPage": true\n    },\n    {\n      "type": "annotate",\n      "label": "Point to settings panel",\n      "targetScreenshot": "studio-loaded",\n      "instructions": "Add a subtle highlight box around the right settings panel and label it 'Settings'."\n    }\n  ]\n}\n```\n\n## Step C — Add npm scripts for this tour\n\nAdd ONLY if missing:\n\n```json\n{\n  "tour:<tourId>": "cross-env TOUR_OVERLAY=0 TOUR_FILE=tourkit/tours/<tourId>.tour.json playwright test tests/e2e/tourkit.spec.ts --grep @tour:<tourId> --headed",\n  "tour:<tourId>:ci": "cross-env TOUR_OVERLAY=0 TOUR_FILE=tourkit/tours/<tourId>.tour.json playwright test tests/e2e/tourkit.spec.ts --grep @tour:<tourId>"\n}\n```\n\n## Step D — VERIFY LOOP (mandatory)\n\nRun:\n```\nnpm run tour:<tourId>:ci\n```\n\nIf it PASSES:\n- Confirm artifacts exist under `/tourkit/artifacts/<tourId>/<timestamp>/`\n- Confirm `annotations.jsonl` exists if any annotate instructions were present\n- Write `/tourkit/artifacts/<tourId>/LATEST.md` with the last passing run info\n- Stop\n\nIf it FAILS:\nCollect evidence every time:\n- failing step number/type from console\n- trace.zip + video.webm\n- runlog.txt\n- dev server runtime errors (Next can stall nav on a single runtime exception)\n\nThen decide:\n- If failure is `waitForEvent` timeout:\n  - Confirm whether the app emitted the event\n  - If not: add emission using `emitTourEvent`\n  - If yes: ensure runner installs event buffer BEFORE any navigation\n- If failure is goto timeout:\n  - Check for app runtime errors in dev server output (missing exports/imports can block route)\n  - Confirm webServer + baseURL correctness\n  - Confirm runner uses stable nav strategy (`waitUntil: "domcontentloaded"` or `"commit"` with sensible timeout)\n- If failure is “element detached”:\n  - Confirm anchor points at the interactive element (not a container)\n  - Ensure safeClick/safeFill retry logic is present\n\nFix, rerun, repeat up to 5 retries. If still failing after 5:\n- Write a final diagnosis naming root cause + exact file/line changes.\n\n## Save this prompt\n\nSave THIS EXACT PROMPT verbatim into:\n`/tourkit/prompts/03-Create-Tour.md`
